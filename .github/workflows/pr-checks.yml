name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check PR title format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|test|refactor|style|chore|hotfix): ]]; then
            echo "‚ùå PR title must start with: feat:|fix:|docs:|test:|refactor:|style:|chore:|hotfix:"
            echo "Current title: $PR_TITLE"
            exit 1
          fi
          echo "‚úÖ PR title format is correct"
      
      - name: Check for merge conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q '<<<<<<<'; then
            echo "‚ùå Merge conflicts detected. Please resolve them."
            exit 1
          fi
          echo "‚úÖ No merge conflicts"
      
      - name: Check branch naming
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          if [[ ! "$BRANCH_NAME" =~ ^(feature|fix|hotfix|docs|test)/ ]]; then
            echo "‚ö†Ô∏è Branch name should follow: feature/*, fix/*, hotfix/*, docs/*, test/*"
            echo "Current branch: $BRANCH_NAME"
          else
            echo "‚úÖ Branch naming is correct"
          fi

  test-coverage:
    name: Test Coverage Report
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-cov
      
      - name: Run tests with coverage
        working-directory: ./backend
        run: |
          pytest tests/ --cov=app --cov-report=term --cov-report=html --cov-report=xml
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: backend/htmlcov/
      
      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        run: |
          echo "üìä Test coverage report generated"
          echo "View detailed report in artifacts"

  changed-files:
    name: Check Changed Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get changed files
        id: changed-files
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check if tests were added for new features
          if echo "$CHANGED_FILES" | grep -q "backend/app/"; then
            if ! echo "$CHANGED_FILES" | grep -q "backend/tests/"; then
              echo "‚ö†Ô∏è Warning: Code changes detected but no test changes"
              echo "Consider adding tests for your changes"
            else
              echo "‚úÖ Tests updated with code changes"
            fi
          fi
      
      - name: Check for sensitive files
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          
          SENSITIVE_PATTERNS=(".env" "*.key" "*.pem" "*.p12" "*password*" "*secret*")
          
          for pattern in "${SENSITIVE_PATTERNS[@]}"; do
            if echo "$CHANGED_FILES" | grep -qi "$pattern"; then
              echo "‚ö†Ô∏è Warning: Potentially sensitive file detected: $pattern"
              echo "Make sure no secrets are committed!"
            fi
          done
          
          echo "‚úÖ No obvious sensitive files detected"

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check if docs need updating
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          
          # Check if API routes changed
          if echo "$CHANGED_FILES" | grep -q "backend/app/routes/"; then
            if ! echo "$CHANGED_FILES" | grep -q "docs/"; then
              echo "‚ö†Ô∏è Warning: API routes changed but no documentation updates"
              echo "Consider updating docs/ if API changed"
            else
              echo "‚úÖ Documentation updated with route changes"
            fi
          fi
          
          # Check if new services added
          if echo "$CHANGED_FILES" | grep -q "backend/app/services/"; then
            echo "‚ÑπÔ∏è Service changes detected - ensure documentation is up to date"
          fi
